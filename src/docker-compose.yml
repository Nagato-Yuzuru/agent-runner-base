services:
  agent-runner:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - USERNAME=runner
        - VCS_REF=${VCS_REF}
        - HOST_USER=${HOST_USER}
        - HOST_OP_PATH=${HOST_OP_PATH}
        - VERSION=${VERSION:-latest}
    deploy:
      resources:
        limits:
          cpus: "4.0"
          memory: 8G
    group_add:
      - 67278
    volumes:
      - /run/host-services/ssh-auth.sock:/run/host-services/ssh-auth.sock
      - ~/.ssh/allowed_signers:/home/runner/.ssh/allowed_signers:ro
      - ~/.config/nvim:/home/runner/.config/nvim:ro
      - ./lazy-lock.agent.json:/home/runner/.config/nvim/lazy-lock.json
      - ./.zshrc:/home/runner/.zshrc
      - ./.zshenv:/home/runner/.zshenv:ro
      - ./.zsh_plugins.txt:/home/runner/.zsh_plugins.txt:ro
      - ~/.config/starship.toml:/home/runner/.config/starship.toml:ro
      - ./.gitconfig:/home/runner/.gitconfig:cache
      - ~/.gitconfig_managed:/home/runner/.gitconfig_managed:ro
        # mount code to container

      - uv_cache:/home/runner/.cache/uv
      - claude_state:/home/runner/.claude
      - anthropic_config:/home/runner/.config/anthropic
      - mise_data:/home/runner/.local/share/mise
      - nvim_data:/home/runner/.local/share/nvim
      - nvim_state:/home/runner/.local/state/nvim
      - antidote_cache:/home/runner/.cache/antidote
    environment:
      - HOST_GATEWAY=host
      - SSH_AUTH_SOCK=/run/host-services/ssh-auth.sock
      - UV_CACHE_DIR=/home/runner/.cache/uv
      - TERM=xterm-256color
      - COLORTERM=truecolor

    command: [ "sleep", "infinity" ]

volumes:
  uv_cache:
  anthropic_config:
  mise_data:
  claude_state:
  nvim_data:
  nvim_state:
  antidote_cache:
